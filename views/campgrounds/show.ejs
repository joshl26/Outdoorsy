<!-- views/campgrounds/show.ejs -->
<link rel="stylesheet" href="/outdoorsy/stylesheets/skeleton.css" />
<link rel="stylesheet" type="text/css" href="/outdoorsy/stylesheets/campgrounds-show.css" />

<%
// Cloudinary helper for responsive images
function cloudinaryTransform(url, transform) {
  if (!url || typeof url !== 'string') return url;
  if (!url.includes('cloudinary.com')) return url;
  return url.replace('/upload/', `/upload/${transform}/`);
}
%>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary" href="/outdoorsy/campgrounds">
      <i class="fas fa-arrow-left me-1" aria-hidden="true"></i>
      <span>Back</span>
    </a>
    <!-- Page title (h1) with safe fallback -->
    <h1 class="m-0">
      Campground
      <% if (campground && campground.title) { %>
        <span> — <%= campground.title %></span>
      <% } %>
    </h1>
  </div>

  <div class="d-flex gap-2">
    <a
      class="btn btn-outline-secondary"
      href="/outdoorsy/campgrounds/nearby?lat=<%= campground.geometry?.coordinates?.[1] ?? '' %>&lng=<%= campground.geometry?.coordinates?.[0] ?? '' %>&radiusKm=25"
    >
      <i class="fas fa-location-arrow me-1" aria-hidden="true"></i>
      <span>Nearby</span>
    </a>

    <% if (currentUser && String(currentUser._id) === String(campground.author?._id || campground.author)) { %>
      <a class="btn btn-outline-primary" href="/outdoorsy/campgrounds/<%= campground.slug || campground._id %>/edit">
        <i class="fas fa-edit me-1" aria-hidden="true"></i>
        <span>Edit</span>
      </a>
    <% } %>

    <% if (currentUser) { %>
      <!-- Favorite button with visible text -->
      <button
        type="button"
        class="btn btn-sm <%= isFavorited ? 'btn-danger' : 'btn-outline-danger' %> toggle-fav-btn"
        data-id="<%= campground._id %>"
        aria-pressed="<%= isFavorited ? 'true' : 'false' %>"
        title="<%= isFavorited ? 'Remove from favorites' : 'Add to favorites' %>"
      >
        <i class="fas fa-heart me-1" aria-hidden="true"></i>
        <span><%= isFavorited ? 'Remove from favorites' : 'Add to favorites' %></span>
      </button>
    <% } %>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-lg-8">
    <!-- Gallery -->
    <section aria-labelledby="gallery-heading" class="card shadow-sm mb-3">
      <div class="card-body p-0">
        <h2 id="gallery-heading" class="visually-hidden">Gallery</h2>

        <!-- Gallery Skeleton -->
        <div id="gallerySkeleton" class="skeleton-box ratio ratio-16x9" aria-hidden="true"></div>

        <% if (campground.images && campground.images.length) { %>
          <div
            id="carouselImages"
            class="carousel slide" style="display:none;"
            data-bs-ride="carousel"
            aria-roledescription="carousel"
          >
            <div class="carousel-inner">
              <% campground.images.forEach((img, idx) => {
                   const width = img.width || 1200;
                   const height = img.height || 800;
                   const baseUrl = img.url;
              %>
                <div class="carousel-item <%= idx === 0 ? 'active' : '' %>">
                  <img
                    src="<%= cloudinaryTransform(baseUrl, 'c_fill,g_auto,f_auto,q_auto,w_1200,h_800') %>"
                    srcset="
                      <%= cloudinaryTransform(baseUrl, 'c_fill,g_auto,f_auto,q_auto,w_400,h_267') %> 400w,
                      <%= cloudinaryTransform(baseUrl, 'c_fill,g_auto,f_auto,q_auto,w_800,h_533') %> 800w,
                      <%= cloudinaryTransform(baseUrl, 'c_fill,g_auto,f_auto,q_auto,w_1200,h_800') %> 1200w
                    "
                    sizes="(max-width: 600px) 100vw, (max-width: 992px) 90vw, 800px"
                    class="d-block w-100"
                    alt="<%= campground.title || 'Campground' %> - View <%= idx + 1 %> of <%= campground.images.length %>"
                    width="<%= width %>"
                    height="<%= height %>"
                    decoding="async"
                    <%= idx === 0 ? 'fetchpriority="high"' : 'loading="lazy"' %>
                    style="max-height: 500px; object-fit: cover; object-position: center; aspect-ratio: <%= width %> / <%= height %>;"
                    onload="window.__galleryImgLoaded && window.__galleryImgLoaded()"
                  />
                </div>
              <% }) %>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselImages" data-bs-slide="prev" aria-label="Previous image">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselImages" data-bs-slide="next" aria-label="Next image">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>
        <% } else { %>
          <img
            id="galleryFallback"
            src="https://placehold.co/1200x500?text=No+Image"
            class="w-100"
            alt="No images available for this campground"
            width="1200"
            height="500"
            decoding="async"
            loading="lazy"
            style="display:none; object-fit: cover; object-position: center; aspect-ratio: 1200 / 500;"
          />
        <% } %>
      </div>
    </section>

    <!-- Details -->
    <section aria-labelledby="details-heading" class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 id="details-heading" class="card-title h5 mb-3">About this campground</h2>
        <p class="card-text"><%= campground.description || 'No description provided.' %></p>
        <div class="d-flex align-items-center gap-3">
          <div class="fw-bold fs-5">$<%= campground.price %> / night</div>
          <div class="text-muted">
            <i class="fas fa-map-marker-alt me-1" aria-hidden="true"></i>
            <%= campground.location %>
          </div>
        </div>
      </div>
    </section>

    <!-- Getting there (HowTo) -->
    <%
      const uiGettingThereSteps = (campground?.gettingThere?.steps?.length
        ? campground.gettingThere.steps
        : [
            { name: 'Head towards the nearest highway', text: 'Use your preferred navigation app to reach the main highway leading to the region.' },
            { name: `Exit towards ${campground.location || 'the campground area'}`, text: `Take the signed exit and follow local road signs for ${campground.title}.` },
            { name: 'Follow local access road', text: 'Proceed carefully on the access road; conditions may vary seasonally.' },
            { name: 'Arrive at the entrance', text: `Look for the ${campground.title} entrance sign and check in if required.` },
          ]);
    %>
    <section aria-labelledby="getting-there-heading" class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 id="getting-there-heading" class="card-title h5 mb-3">How to get to <%= campground.title %></h2>

        <% if (campground?.gettingThere?.totalTimeISO) { %>
          <p class="text-muted mb-2">Estimated time: <%= campground.gettingThere.totalTimeISO %></p>
        <% } %>

        <% if (Array.isArray(campground?.gettingThere?.supply) && campground.gettingThere.supply.length) { %>
          <div class="mb-2">
            <strong>Suggested supplies:</strong>
            <ul class="mb-0">
              <% campground.gettingThere.supply.forEach(s => { %>
                <li><%= s %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <% if (Array.isArray(campground?.gettingThere?.tool) && campground.gettingThere.tool.length) { %>
          <div class="mb-3">
            <strong>Tools:</strong>
            <ul class="mb-0">
              <% campground.gettingThere.tool.forEach(t => { %>
                <li><%= t %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <ol class="list-group list-group-numbered">
          <% uiGettingThereSteps.forEach((s) => { %>
            <li class="list-group-item">
              <div class="fw-semibold"><%= s.name %></div>
              <% if (s.text) { %><div class="text-muted"><%= s.text %></div><% } %>
              <% if (s.url) { %>
                <div class="mt-1">
                  <a class="link-primary" href="<%= s.url %>" target="_blank" rel="noopener">Open step link</a>
                </div>
              <% } %>
              <% if (s.image) { %>
                <div class="mt-2">
                  <img 
                    src="<%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_800') %>" 
                    srcset="
                      <%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_400') %> 400w,
                      <%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_800') %> 800w
                    "
                    sizes="(max-width: 600px) 100vw, 800px"
                    class="img-fluid rounded" 
                    alt="<%= s.name %>" 
                    loading="lazy" 
                    decoding="async"
                  />
                </div>
              <% } %>
            </li>
          <% }) %>
        </ol>
      </div>
    </section>

    <!-- Booking guide (HowTo) -->
    <%
      const uiBookingSteps = (campground?.bookingGuide?.steps?.length
        ? campground.bookingGuide.steps
        : [
            { name: 'Check availability', text: `On the ${campground.title} page, select your dates to check availability.` },
            { name: 'Review details', text: 'Review campsite details, rules, pricing, and cancellation policy before booking.' },
            { name: 'Complete booking', text: 'Proceed to checkout, provide guest details, and confirm your reservation.' },
            { name: 'Receive confirmation', text: 'You will receive a booking confirmation with check-in instructions via email.' },
          ]);
    %>
    <section aria-labelledby="booking-guide-heading" class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 id="booking-guide-heading" class="card-title h5 mb-3">How to book <%= campground.title %></h2>

        <% if (campground?.bookingGuide?.totalTimeISO) { %>
          <p class="text-muted mb-2">Estimated time: <%= campground.bookingGuide.totalTimeISO %></p>
        <% } %>

        <% if (Array.isArray(campground?.bookingGuide?.supply) && campground.bookingGuide.supply.length) { %>
          <div class="mb-2">
            <strong>What you'll need:</strong>
            <ul class="mb-0">
              <% campground.bookingGuide.supply.forEach(s => { %>
                <li><%= s %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <% if (Array.isArray(campground?.bookingGuide?.tool) && campground.bookingGuide.tool.length) { %>
          <div class="mb-3">
            <strong>Tools:</strong>
            <ul class="mb-0">
              <% campground.bookingGuide.tool.forEach(t => { %>
                <li><%= t %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <ol class="list-group list-group-numbered">
          <% uiBookingSteps.forEach((s) => { %>
            <li class="list-group-item">
              <div class="fw-semibold"><%= s.name %></div>
              <% if (s.text) { %><div class="text-muted"><%= s.text %></div><% } %>
              <% if (s.url) { %>
                <div class="mt-1">
                  <a class="link-primary" href="<%= s.url %>" target="_blank" rel="noopener">Open step link</a>
                </div>
              <% } %>
              <% if (s.image) { %>
                <div class="mt-2">
                  <img 
                    src="<%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_800') %>" 
                    srcset="
                      <%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_400') %> 400w,
                      <%= cloudinaryTransform(s.image, 'c_fill,g_auto,f_auto,q_auto,w_800') %> 800w
                    "
                    sizes="(max-width: 600px) 100vw, 800px"
                    class="img-fluid rounded" 
                    alt="<%= s.name %>" 
                    loading="lazy" 
                    decoding="async"
                  />
                </div>
              <% } %>
            </li>
          <% }) %>
        </ol>
      </div>
    </section>

    <!-- FAQ (aligns with FAQPage JSON-LD) -->
    <%
      const uiFaq = (Array.isArray(campground?.faq) && campground.faq.length
        ? campground.faq
        : [
            { q: `Are pets allowed at ${campground.title}?`, a: 'Yes, friendly pets are generally welcome on a leash unless otherwise stated in the rules.' },
            { q: `What facilities are available at ${campground.title}?`, a: 'Facilities vary by site; many include restrooms, showers, and picnic tables. Check the listing for details.' },
            { q: `How do I make a reservation for ${campground.title}?`, a: 'Book directly on Outdoorsy by selecting dates and confirming your stay from the campground page.' },
          ]);
    %>
    <section aria-labelledby="faq-heading" class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 id="faq-heading" class="card-title h5 mb-3">Frequently asked questions</h2>
        <% if (!uiFaq || !uiFaq.length) { %>
          <div class="text-muted">No FAQs available.</div>
        <% } else { %>
          <div class="accordion" id="faqAccordion">
            <% uiFaq.forEach((item, idx) => { 
                 const headingId = `faq-heading-${idx}`;
                 const collapseId = `faq-collapse-${idx}`;
            %>
              <div class="accordion-item">
                <h3 class="accordion-header" id="<%= headingId %>">
                  <button class="accordion-button <%= idx === 0 ? '' : 'collapsed' %>" type="button" data-bs-toggle="collapse" data-bs-target="#<%= collapseId %>" aria-expanded="<%= idx === 0 ? 'true' : 'false' %>" aria-controls="<%= collapseId %>">
                    <%= item.q %>
                  </button>
                </h3>
                <div id="<%= collapseId %>" class="accordion-collapse collapse <%= idx === 0 ? 'show' : '' %>" aria-labelledby="<%= headingId %>" data-bs-parent="#faqAccordion">
                  <div class="accordion-body">
                    <%= item.a %>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
    </section>

    <!-- Reviews -->
    <section aria-labelledby="reviews-heading" class="card shadow-sm">
      <div class="card-body">
        <h2 id="reviews-heading" class="card-title h5 mb-3">Reviews</h2>

        <% if (!reviews || reviews.length === 0) { %>
          <div class="text-muted">No reviews yet.</div>
        <% } else { %>
          <div class="list-group">
            <% reviews.forEach(r => { %>
              <article class="list-group-item">
                <header class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= r.author?.username || r.author?.email || 'Anonymous' %></strong>
                    <span class="text-muted small ms-2"><%= new Date(r.createdAt).toLocaleString() %></span>
                  </div>
                </header>
                <p class="mb-1 mt-2"><%= r.body %></p>
                <% if (typeof r.rating === 'number') { %>
                  <div class="text-warning" role="img" aria-label="<%= r.rating %> out of 5 stars">
                    <% for (let i = 0; i < r.rating; i++) { %><i class="fas fa-star" aria-hidden="true"></i><% } %>
                    <% for (let i = r.rating; i < 5; i++) { %><i class="far fa-star" aria-hidden="true"></i><% } %>
                  </div>
                <% } %>
              </article>
            <% }) %>
          </div>

          <% if (typeof reviewsTotalPages !== 'undefined' && reviewsTotalPages > 1) { %>
            <nav aria-label="Reviews pagination" class="mt-3">
              <ul class="pagination justify-content-center">
                <li class="page-item <%= reviewsPage <= 1 ? 'disabled' : '' %>">
                  <% if (reviewsPage <= 1) { %>
                    <span class="page-link" aria-disabled="true">Previous</span>
                  <% } else { %>
                    <a class="page-link" href="?page=<%= reviewsPage - 1 %>&limit=<%= reviewsLimit %>">Previous</a>
                  <% } %>
                </li>
                <% for (let p = 1; p <= reviewsTotalPages; p++) { %>
                  <li class="page-item <%= p === reviewsPage ? 'active' : '' %>">
                    <% if (p === reviewsPage) { %>
                      <span class="page-link" aria-current="page">Page <%= p %></span>
                    <% } else { %>
                      <a class="page-link" href="?page=<%= p %>&limit=<%= reviewsLimit %>">Page <%= p %></a>
                    <% } %>
                  </li>
                <% } %>
                <li class="page-item <%= reviewsPage >= reviewsTotalPages ? 'disabled' : '' %>">
                  <% if (reviewsPage >= reviewsTotalPages) { %>
                    <span class="page-link" aria-disabled="true">Next</span>
                  <% } else { %>
                    <a class="page-link" href="?page=<%= reviewsPage + 1 %>&limit=<%= reviewsLimit %>">Next</a>
                  <% } %>
                </li>
              </ul>
            </nav>
          <% } %>
        <% } %>
      </div>
    </section>
  </div>

  <!-- Sidebar -->
  <div class="col-12 col-lg-4">
    <section aria-labelledby="host-heading" class="card shadow-sm mb-3">
      <div class="card-body">
        <h2 id="host-heading" class="card-title h6">Host</h2>
        <p class="mb-1">
          <strong><%= campground.author?.username || campground.author?.email || 'Unknown' %></strong>
        </p>
        <p class="text-muted mb-0">
          <i class="far fa-clock me-1" aria-hidden="true"></i>
          Listed <%= campground.createdAt ? new Date(campground.createdAt).toLocaleDateString() : '' %>
        </p>
      </div>
    </section>

    <% if (campground.geometry?.coordinates?.length === 2) { %>
      <section aria-labelledby="location-heading" class="card shadow-sm">
        <div class="card-body">
          <h2 id="location-heading" class="card-title h6">Location</h2>
          <div class="text-muted mb-2"><%= campground.location %></div>

          <!-- Map Skeleton -->
          <div id="staticMapSkeleton" class="skeleton-box ratio ratio-16x9" aria-hidden="true"></div>

          <div
            class="ratio ratio-16x9 bg-light rounded"
            id="staticMap"
            style="display:none;"
            data-lng="<%= campground.geometry.coordinates[0] %>"
            data-lat="<%= campground.geometry.coordinates[1] %>"
            data-token="<%= mapboxToken %>"
            data-zoom="10"
            data-size="800x450@2x"
            data-style="mapbox/outdoors-v12"
            data-pin="pin-s+ff0000"
            role="img"
            aria-label="Map preview of campground location"
          ></div>
        </div>
      </section>
      <!-- External, CSP-safe map loader -->
      <script src="/outdoorsy/js/static-map.js" defer></script>
    <% } %>
  </div>
</div>

<!-- External, CSP-safe favorites handler -->
<script src="/outdoorsy/js/favorites.js" defer></script>

<!-- Skeleton + reveal logic (tiny, CSP-safe) -->
<script defer>
  window.__galleryReadyCount = 0;
  window.__galleryImgLoaded = function () {
    window.__galleryReadyCount = (window.__galleryReadyCount || 0) + 1;
    // Show after first image to reduce TTI
    if (window.__galleryReadyCount >= 1) {
      const skel = document.getElementById('gallerySkeleton');
      const car = document.getElementById('carouselImages');
      const fb = document.getElementById('galleryFallback');
      if (skel) skel.style.display = 'none';
      if (car) car.style.display = '';
      if (!car && fb) fb.style.display = '';
    }
  };

  // Fallback: reveal after timeout in case onload doesn't fire
  document.addEventListener('DOMContentLoaded', function () {
    setTimeout(function () {
      const car = document.getElementById('carouselImages');
      if (!car || car.style.display === 'none') {
        const skel = document.getElementById('gallerySkeleton');
        const fb = document.getElementById('galleryFallback');
        if (skel) skel.style.display = 'none';
        if (car) car.style.display = '';
        if (!car && fb) fb.style.display = '';
      }
    }, 1200);

    // Static map reveal hook — static-map.js should dispatch a custom event when the image loads
    document.addEventListener('static-map:loaded', function () {
      const sk = document.getElementById('staticMapSkeleton');
      const map = document.getElementById('staticMap');
      if (sk) sk.style.display = 'none';
      if (map) map.style.display = '';
    });
  });
</script>

<style>
  .carousel .carousel-item img { border-radius: .5rem; }
  .visually-hidden-focusable:active,
  .visually-hidden-focusable:focus {
    position: static; width: auto; height: auto; overflow: visible; clip: auto;
  }
</style>