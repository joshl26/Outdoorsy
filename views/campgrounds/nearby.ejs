<!-- views/campgrounds/nearby.ejs -->
<head>
  <link rel="stylesheet" type="text/css" href="/outdoorsy/stylesheets/campgrounds-index.css" />
</head>
<div class="fade-in">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 id="nearbyHeading" class="text-primary m-0">Nearby Campgrounds</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="/outdoorsy/campgrounds">
        <i class="fas fa-list me-1" aria-hidden="true"></i>
        <span>Back to All</span>
      </a>
      <a class="btn btn-outline-secondary" href="/outdoorsy/favorites">
        <i class="fas fa-heart me-1" aria-hidden="true"></i>
        <span>Favorites</span>
      </a>
    </div>
  </div>

  <!-- Filters section -->
  <section aria-labelledby="nearby-filters-heading" class="card mb-4 shadow-sm">
    <div class="card-body">
      <h2 id="nearby-filters-heading" class="h5 mb-3">Filters</h2>
      <form
        method="GET"
        action="/outdoorsy/campgrounds/nearby"
        class="row g-3"
        id="nearbyForm"
        novalidate
      >
        <fieldset>
          <legend class="visually-hidden">Search nearby campgrounds</legend>

          <div class="col-12 col-md-3">
            <label for="q" class="form-label">Search</label>
            <input
              type="text"
              id="q"
              name="q"
              class="form-control"
              placeholder="Title, description, location..."
              value="<%= typeof q !== 'undefined' ? q : '' %>"
            />
          </div>

          <div class="col-6 col-md-2">
            <label for="minPrice" class="form-label">Min Price</label>
            <input
              type="number"
              id="minPrice"
              name="minPrice"
              class="form-control"
              min="0"
              step="1"
              value="<%= typeof minPrice !== 'undefined' ? minPrice : '' %>"
            />
          </div>

          <div class="col-6 col-md-2">
            <label for="maxPrice" class="form-label">Max Price</label>
            <input
              type="number"
              id="maxPrice"
              name="maxPrice"
              class="form-control"
              min="0"
              step="1"
              value="<%= typeof maxPrice !== 'undefined' ? maxPrice : '' %>"
            />
          </div>

          <div class="col-6 col-md-2">
            <label for="lat" class="form-label">Latitude</label>
            <input
              type="number"
              id="lat"
              name="lat"
              class="form-control"
              step="0.000001"
              min="-90"
              max="90"
              value="<%= typeof lat !== 'undefined' && lat !== '' ? lat : '' %>"
            />
          </div>

          <div class="col-6 col-md-2">
            <label for="lng" class="form-label">Longitude</label>
            <input
              type="number"
              id="lng"
              name="lng"
              class="form-control"
              step="0.000001"
              min="-180"
              max="180"
              value="<%= typeof lng !== 'undefined' && lng !== '' ? lng : '' %>"
            />
          </div>

          <div class="col-6 col-md-2">
            <label for="radiusKm" class="form-label">Radius (km)</label>
            <input
              type="number"
              id="radiusKm"
              name="radiusKm"
              class="form-control"
              min="1"
              max="500"
              step="1"
              aria-describedby="radiusHelp"
              value="<%= typeof radiusKm !== 'undefined' && radiusKm !== '' ? radiusKm : 25 %>"
            />
            <small id="radiusHelp" class="form-text text-muted">
              Distance in kilometers (max 500)
            </small>
          </div>

          <!-- Sort By -->
          <div class="col-6 col-md-2">
            <label for="sort" class="form-label">Sort By</label>
            <select id="sort" name="sort" class="form-select">
              <% if (sort === 'priceAsc') { %>
                <option value="distance">Distance</option>
                <option value="priceAsc" selected>Price: Low to High</option>
                <option value="priceDesc">Price: High to Low</option>
              <% } else if (sort === 'priceDesc') { %>
                <option value="distance">Distance</option>
                <option value="priceAsc">Price: Low to High</option>
                <option value="priceDesc" selected>Price: High to Low</option>
              <% } else { %>
                <option value="distance" selected>Distance</option>
                <option value="priceAsc">Price: Low to High</option>
                <option value="priceDesc">Price: High to Low</option>
              <% } %>
            </select>
          </div>

          <div class="col-12 col-md-6 d-flex align-items-end gap-2 mt-2">
            <button
              type="button"
              class="btn btn-outline-primary"
              id="useLocationBtn"
              aria-live="polite"
              aria-label="Use my current location to find nearby campgrounds"
            >
              <i class="fas fa-crosshairs me-1" aria-hidden="true"></i>
              <span>Use My Location</span>
            </button>
            <button type="submit" class="btn btn-primary flex-grow-1">
              <i class="fas fa-location-arrow me-1" aria-hidden="true"></i>
              <span>Find Nearby</span>
            </button>
          </div>
        </fieldset>
      </form>
    </div>
  </section>

  <!-- View Toggle (no heading required) -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="btn-group" role="group" aria-labelledby="viewToggleLabel">
      <span id="viewToggleLabel" class="visually-hidden">Toggle view mode</span>

      <input
        type="radio"
        class="btn-check"
        name="viewMode"
        id="viewGrid"
        checked
      />
      <label class="btn btn-outline-primary" for="viewGrid">
        <i class="fas fa-th me-1" aria-hidden="true"></i>
        <span>Grid</span>
      </label>

      <input
        type="radio"
        class="btn-check"
        name="viewMode"
        id="viewMap"
      />
      <label class="btn btn-outline-primary" for="viewMap">
        <i class="fas fa-map me-1" aria-hidden="true"></i>
        <span>Map</span>
      </label>
    </div>
  </div>

  <!-- Map section -->
  <section aria-labelledby="nearby-map-heading">
    <h2 id="nearby-map-heading" class="visually-hidden">Map Results</h2>
    <div id="mapContainer" class="card mb-4 shadow-sm" style="display:none;">
      <div id="nearbyMap" style="height:520px;" role="region" aria-label="Nearby campgrounds map"></div>
    </div>
  </section>

  <!-- Grid section -->
  <section aria-labelledby="nearby-results-heading" id="gridContainer">
    <h2 id="nearby-results-heading" class="visually-hidden">Campground Results</h2>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="text-muted" aria-live="polite">
        <%= total %> result<%= total === 1 ? '' : 's' %>
        <% if (radiusKm) { %> within <%= radiusKm %> km<% } %>
      </div>
      <% if (typeof page !== 'undefined' && typeof totalPages !== 'undefined' && totalPages > 0) { %>
        <div class="text-muted">Page <%= page %> of <%= totalPages %></div>
      <% } %>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
      <% (campgrounds || []).forEach((cg) => { %>
        <div class="col">
          <article class="card h-100 shadow-sm">
            <% const cover = (cg.images && cg.images.length)
                 ? cg.images[0].url
                 : 'https://placehold.co/600x400?text=No+Image'; %>
            <img src="<%= cover %>" class="card-img-top" alt="<%= cg.title %> cover" />
            <div class="card-body d-flex flex-column">
              <h3 class="card-title h5">
                <a class="text-decoration-none" href="/outdoorsy/campgrounds/<%= cg._id %>"><%= cg.title %></a>
              </h3>
              <p class="card-text text-muted mb-1">
                <i class="fas fa-map-marker-alt me-1" aria-hidden="true"></i>
                <%= cg.location %>
              </p>
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="fw-bold">$<%= cg.price %> / night</div>
                <% if (typeof cg.distance === 'number') { %>
                  <span class="badge bg-info-subtle text-info border">
                    <i class="fas fa-route me-1" aria-hidden="true"></i>
                    <%= (cg.distance / 1000).toFixed(1) %> km away
                  </span>
                <% } %>
              </div>
              <div class="mt-auto d-flex gap-2">
                <a class="btn btn-sm btn-primary flex-grow-1" href="/outdoorsy/campgrounds/<%= cg._id %>">View</a>
                <% if (currentUser) { %>
                  <button
                    type="button"
                    class="btn btn-sm <%= (favorites || []).includes(String(cg._id)) ? 'btn-danger' : 'btn-outline-danger' %> toggle-fav-btn"
                    data-id="<%= cg._id %>"
                    aria-pressed="<%= (favorites || []).includes(String(cg._id)) ? 'true' : 'false' %>"
                    aria-label="<%= (favorites || []).includes(String(cg._id)) ? 'Remove from favorites' : 'Add to favorites' %>"
                    title="<%= (favorites || []).includes(String(cg._id)) ? 'Remove from favorites' : 'Add to favorites' %>"
                  >
                    <i class="fas fa-heart" aria-hidden="true"></i>
                    <span class="visually-hidden">
                      <%= (favorites || []).includes(String(cg._id)) ? 'Remove from favorites' : 'Add to favorites' %>
                    </span>
                    <span>Favorite</span>
                  </button>
                <% } %>
              </div>
            </div>
          </article>
        </div>
      <% }) %>
    </div>

    <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
      <%
        const params = new URLSearchParams();
        if (q) params.set('q', q);
        if (minPrice !== '' && typeof minPrice !== 'undefined') params.set('minPrice', minPrice);
        if (maxPrice !== '' && typeof maxPrice !== 'undefined') params.set('maxPrice', maxPrice);
        if (lat !== '' && typeof lat !== 'undefined') params.set('lat', lat);
        if (lng !== '' && typeof lng !== 'undefined') params.set('lng', lng);
        if (radiusKm !== '' && typeof radiusKm !== 'undefined') params.set('radiusKm', radiusKm);
        if (sort) params.set('sort', sort);

        function pageUrl(p) {
          const u = new URLSearchParams(params);
          u.set('page', p);
          return `/outdoorsy/campgrounds/nearby?${u.toString()}`;
        }
      %>
      <nav aria-label="Nearby pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item <%= page <= 1 ? 'disabled' : '' %>">
            <% if (page <= 1) { %>
              <span class="page-link" aria-disabled="true">Previous</span>
            <% } else { %>
              <a class="page-link" href="<%= pageUrl(page - 1) %>">Previous</a>
            <% } %>
          </li>
          <% for (let p = 1; p <= totalPages; p++) { %>
            <li class="page-item <%= p === page ? 'active' : '' %>">
              <% if (p === page) { %>
                <span class="page-link" aria-current="page">Page <%= p %></span>
              <% } else { %>
                <a class="page-link" href="<%= pageUrl(p) %>">Page <%= p %></a>
              <% } %>
            </li>
          <% } %>
          <li class="page-item <%= page >= totalPages ? 'disabled' : '' %>">
            <% if (page >= totalPages) { %>
              <span class="page-link" aria-disabled="true">Next</span>
            <% } else { %>
              <a class="page-link" href="<%= pageUrl(page + 1) %>">Next</a>
            <% } %>
          </li>
        </ul>
      </nav>
    <% } %>
  </section>
</div>